<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hard Money Loan Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #fafbfc;
            min-height: 100vh;
            padding: 20px;
            color: #0f172a;
            line-height: 1.6;
        }

        .container {
            max-width: 1280px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 48px;
            padding: 60px 20px 40px;
        }

        h1 {
            color: #0f172a;
            margin-bottom: 12px;
            font-size: 3em;
            font-weight: 700;
            letter-spacing: -1.5px;
        }

        .subtitle {
            color: #64748b;
            font-size: 1.125rem;
            font-weight: 400;
            max-width: 600px;
            margin: 0 auto;
        }

        .button-bar {
            display: flex;
            gap: 12px;
            margin: 32px 0;
            flex-wrap: wrap;
            justify-content: center;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 0.9375rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .btn-load {
            background: white;
            color: #0f172a;
            border: 1px solid #cbd5e1;
            position: relative;
            overflow: hidden;
        }

        .btn-load:hover {
            background: #f8fafc;
            border-color: #94a3b8;
        }

        .btn-load input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .section {
            background: white;
            padding: 32px;
            border-radius: 12px;
            margin-bottom: 24px;
            border: 1px solid #e2e8f0;
            transition: box-shadow 0.2s;
        }

        .section:hover {
            box-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 4px 12px rgba(0,0,0,0.04);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #0f172a;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toggle-icon {
            color: #64748b;
            transition: transform 0.3s;
            font-size: 1.25rem;
        }

        .section.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .section-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
        }

        .section.collapsed .section-content {
            display: none;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 500;
            color: #0f172a;
            margin-bottom: 8px;
            font-size: 0.875rem;
        }

        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 0.9375rem;
            transition: all 0.15s ease;
            background: white;
            color: #0f172a;
        }

        input[type="text"]:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.08);
        }

        input[type="text"]:hover,
        input[type="number"]:hover {
            border-color: #94a3b8;
        }

        .input-with-prefix {
            position: relative;
        }

        .input-prefix {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #64748b;
            font-size: 0.9375rem;
            pointer-events: none;
        }

        .input-with-prefix input {
            padding-left: 28px;
        }

        .calculate-section {
            display: flex;
            justify-content: center;
            margin: 32px 0;
        }

        .btn-calculate {
            background: #2563eb;
            color: white;
            padding: 14px 32px;
            font-size: 1rem;
            font-weight: 600;
        }

        .btn-calculate:hover {
            background: #1d4ed8;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
        }

        .btn-calculate:active {
            transform: translateY(1px);
        }

        .report {
            background: white;
            border-radius: 12px;
            padding: 40px;
            margin-top: 40px;
            border: 1px solid #e2e8f0;
            display: none;
        }

        .report.show {
            display: block;
        }

        .report-header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 2px solid #e2e8f0;
        }

        .report-title {
            font-size: 2rem;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 8px;
        }

        .report-subtitle {
            color: #64748b;
            font-size: 0.9375rem;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .metric-card {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            text-align: center;
        }

        .metric-label {
            font-size: 0.8125rem;
            color: #64748b;
            font-weight: 500;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #0f172a;
        }

        .metric-value.positive {
            color: #22c55e;
        }

        .metric-value.negative {
            color: #ef4444;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin: 30px 0;
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .breakdown-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }

        .breakdown-table th {
            background: #f8fafc;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #0f172a;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #e2e8f0;
        }

        .breakdown-table td {
            padding: 12px;
            border-bottom: 1px solid #f1f5f9;
            color: #475569;
        }

        .breakdown-table tr:last-child td {
            border-bottom: none;
        }

        .breakdown-table tr:hover {
            background: #f8fafc;
        }

        .breakdown-table .total-row {
            font-weight: 600;
            background: #f8fafc;
            color: #0f172a;
        }

        .breakdown-table .total-row td {
            border-top: 2px solid #cbd5e1;
            padding: 16px 12px;
        }

        .summary-section {
            background: #f8fafc;
            padding: 30px;
            border-radius: 8px;
            margin: 30px 0;
            border: 1px solid #e2e8f0;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .summary-row:last-child {
            border-bottom: none;
            font-weight: 600;
            font-size: 1.125rem;
            padding-top: 16px;
            border-top: 2px solid #cbd5e1;
            margin-top: 8px;
        }

        .summary-label {
            color: #64748b;
            font-size: 0.9375rem;
        }

        .summary-value {
            color: #0f172a;
            font-weight: 600;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid #e2e8f0;
        }

        .btn-action {
            background: white;
            color: #0f172a;
            border: 1px solid #cbd5e1;
        }

        .btn-action:hover {
            background: #f8fafc;
            border-color: #94a3b8;
        }

        .btn-primary-action {
            background: #2563eb;
            color: white;
        }

        .btn-primary-action:hover {
            background: #1d4ed8;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }

            .section {
                box-shadow: none;
                border: 1px solid #ddd;
                page-break-inside: avoid;
            }

            .action-buttons,
            .button-bar,
            .btn-load {
                display: none;
            }

            .report {
                box-shadow: none;
            }
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2em;
            }

            .header {
                padding: 40px 20px 20px;
            }

            .section {
                padding: 20px;
            }

            .section-content {
                grid-template-columns: 1fr;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .chart-container {
                height: 300px;
            }
        }

        .info-note {
            background: #eff6ff;
            border-left: 4px solid #2563eb;
            padding: 16px;
            margin: 20px 0;
            border-radius: 4px;
            font-size: 0.9375rem;
            color: #1e40af;
        }

        .warning-note {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 16px;
            margin: 20px 0;
            border-radius: 4px;
            font-size: 0.9375rem;
            color: #92400e;
        }

        .deal-alert {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            padding: 32px;
            border-radius: 12px;
            margin: 30px 0;
            text-align: center;
            display: none;
            animation: slideIn 0.3s ease-out;
            border: 1px solid #16a34a;
        }

        .deal-alert.show {
            display: block;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .deal-alert h3 {
            font-size: 1.5rem;
            margin-bottom: 12px;
            font-weight: 700;
        }

        .deal-alert p {
            margin-bottom: 20px;
            font-size: 1rem;
            opacity: 0.95;
        }

        .btn-generate-report {
            background: white;
            color: #16a34a;
            padding: 12px 32px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .btn-generate-report:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .quick-results-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #0f172a;
            margin-bottom: 24px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Hard Money Loan Calculator</h1>
            <p class="subtitle">Analyze your fix & flip investment with comprehensive cost breakdowns and profit projections</p>
        </div>

        <div class="button-bar">
            <button class="btn-load">
                📁 Load Saved Project
                <input type="file" id="loadFile" accept=".json">
            </button>
        </div>

        <!-- Project Details Section -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                <div class="section-title">📋 Project Details</div>
                <span class="toggle-icon">▼</span>
            </div>
            <div class="section-content">
                <div class="input-group">
                    <label for="projectTitle">Project Name</label>
                    <input type="text" id="projectTitle" placeholder="e.g., 123 Main St Flip">
                </div>
                <div class="input-group">
                    <label for="purchasePrice">Purchase Price</label>
                    <div class="input-with-prefix">
                        <span class="input-prefix">$</span>
                        <input type="number" id="purchasePrice" value="200000" min="0" step="1000">
                    </div>
                </div>
                <div class="input-group">
                    <label for="renovationCosts">Renovation Costs</label>
                    <div class="input-with-prefix">
                        <span class="input-prefix">$</span>
                        <input type="number" id="renovationCosts" value="50000" min="0" step="1000">
                    </div>
                </div>
                <div class="input-group">
                    <label for="arv">After Repair Value (ARV)</label>
                    <div class="input-with-prefix">
                        <span class="input-prefix">$</span>
                        <input type="number" id="arv" value="300000" min="0" step="1000">
                    </div>
                </div>
            </div>
        </div>

        <!-- Loan Terms Section -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                <div class="section-title">💰 Loan Terms</div>
                <span class="toggle-icon">▼</span>
            </div>
            <div class="section-content">
                <div class="input-group">
                    <label for="interestRate">Interest Rate (Annual %)</label>
                    <div class="input-with-prefix">
                        <span class="input-prefix">%</span>
                        <input type="number" id="interestRate" value="12" min="0" max="30" step="0.1">
                    </div>
                </div>
                <div class="input-group">
                    <label for="loanTerm">Loan Term (Months)</label>
                    <input type="number" id="loanTerm" value="12" min="1" max="60" step="1">
                </div>
                <div class="input-group">
                    <label for="maxLTV">Max LTV % (of ARV)</label>
                    <div class="input-with-prefix">
                        <span class="input-prefix">%</span>
                        <input type="number" id="maxLTV" value="70" min="0" max="100" step="1">
                    </div>
                </div>
                <div class="input-group">
                    <label for="lenderPoints">Lender Points (%)</label>
                    <div class="input-with-prefix">
                        <span class="input-prefix">%</span>
                        <input type="number" id="lenderPoints" value="2" min="0" max="10" step="0.5">
                    </div>
                </div>
            </div>
        </div>

        <!-- Buying Costs Section -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                <div class="section-title">🏠 Buying Costs</div>
                <span class="toggle-icon">▼</span>
            </div>
            <div class="section-content">
                <div class="input-group">
                    <label for="titleCompany">Title Company Fee</label>
                    <div class="input-with-prefix">
                        <span class="input-prefix">$</span>
                        <input type="number" id="titleCompany" value="1500" min="0" step="100">
                    </div>
                </div>
                <div class="input-group">
                    <label for="buyTransferTax">Transfer Tax (Buy)</label>
                    <div class="input-with-prefix">
                        <span class="input-prefix">$</span>
                        <input type="number" id="buyTransferTax" value="2000" min="0" step="100">
                    </div>
                </div>
                <div class="input-group">
                    <label for="otherBuying">Other Buying Costs</label>
                    <div class="input-with-prefix">
                        <span class="input-prefix">$</span>
                        <input type="number" id="otherBuying" value="1000" min="0" step="100">
                    </div>
                </div>
            </div>
        </div>

        <!-- Carrying Costs Section -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                <div class="section-title">📊 Carrying Costs (Monthly)</div>
                <span class="toggle-icon">▼</span>
            </div>
            <div class="section-content">
                <div class="input-group">
                    <label for="propertyTax">Property Tax (Annual)</label>
                    <div class="input-with-prefix">
                        <span class="input-prefix">$</span>
                        <input type="number" id="propertyTax" value="4000" min="0" step="100">
                    </div>
                </div>
                <div class="input-group">
                    <label for="insurance">Insurance (Annual)</label>
                    <div class="input-with-prefix">
                        <span class="input-prefix">$</span>
                        <input type="number" id="insurance" value="1200" min="0" step="100">
                    </div>
                </div>
                <div class="input-group">
                    <label for="utilities">Utilities (Monthly)</label>
                    <div class="input-with-prefix">
                        <span class="input-prefix">$</span>
                        <input type="number" id="utilities" value="200" min="0" step="10">
                    </div>
                </div>
                <div class="input-group">
                    <label for="otherCarrying">Other Monthly Costs</label>
                    <div class="input-with-prefix">
                        <span class="input-prefix">$</span>
                        <input type="number" id="otherCarrying" value="100" min="0" step="10">
                    </div>
                </div>
            </div>
        </div>

        <!-- Selling Costs Section -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                <div class="section-title">💵 Selling Costs</div>
                <span class="toggle-icon">▼</span>
            </div>
            <div class="section-content">
                <div class="input-group">
                    <label for="agentCommission">Agent Commission (%)</label>
                    <div class="input-with-prefix">
                        <span class="input-prefix">%</span>
                        <input type="number" id="agentCommission" value="6" min="0" max="10" step="0.5">
                    </div>
                </div>
                <div class="input-group">
                    <label for="sellTransferTax">Transfer Tax (Sell)</label>
                    <div class="input-with-prefix">
                        <span class="input-prefix">$</span>
                        <input type="number" id="sellTransferTax" value="3000" min="0" step="100">
                    </div>
                </div>
                <div class="input-group">
                    <label for="buyerContributions">Buyer Contributions</label>
                    <div class="input-with-prefix">
                        <span class="input-prefix">$</span>
                        <input type="number" id="buyerContributions" value="5000" min="0" step="100">
                    </div>
                </div>
                <div class="input-group">
                    <label for="otherSelling">Other Selling Costs</label>
                    <div class="input-with-prefix">
                        <span class="input-prefix">$</span>
                        <input type="number" id="otherSelling" value="1000" min="0" step="100">
                    </div>
                </div>
            </div>
        </div>

        <div class="calculate-section">
            <button class="btn-calculate" onclick="calculate()">Calculate Investment</button>
        </div>

        <!-- Deal Alert -->
        <div class="deal-alert" id="dealAlert">
            <div class="deal-alert-content">
                <h3>✓ This Deal Shows Strong Potential!</h3>
                <p>Based on your numbers, this investment appears profitable. Generate a detailed underwriting report to present to investors and lenders.</p>
                <button class="btn-generate-report" onclick="generateReport()">Generate Detailed Underwriting Report</button>
            </div>
        </div>

        <!-- Quick Results Section -->
        <div id="quickResults" class="report">
            <h2 class="quick-results-title">Investment Analysis Summary</h2>
            <div class="report-header">
                <div class="report-title" id="reportTitle">Investment Analysis Report</div>
                <div class="report-subtitle">Comprehensive breakdown of your fix & flip project</div>
            </div>

            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">Net Profit</div>
                    <div class="metric-value positive" id="netProfit">$0</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">ROI</div>
                    <div class="metric-value" id="roi">0%</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Annualized ROI</div>
                    <div class="metric-value" id="annualizedRoi">0%</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Total Investment</div>
                    <div class="metric-value" id="totalInvestment">$0</div>
                </div>
            </div>

            <div class="chart-container">
                <canvas id="costsChart"></canvas>
            </div>

            <h3 style="margin: 30px 0 20px; color: #0f172a; font-size: 1.25rem;">Financing Structure</h3>
            <div class="summary-section">
                <div class="summary-row">
                    <span class="summary-label">Loan Amount</span>
                    <span class="summary-value" id="loanAmount">$0</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Out of Pocket Required</span>
                    <span class="summary-value" id="outOfPocket">$0</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Monthly Interest Payment</span>
                    <span class="summary-value" id="monthlyInterest">$0</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Total Interest Paid</span>
                    <span class="summary-value" id="totalInterest">$0</span>
                </div>
            </div>

            <h3 style="margin: 30px 0 20px; color: #0f172a; font-size: 1.25rem;">Buying Costs Breakdown</h3>
            <table class="breakdown-table">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th style="text-align: right;">Amount</th>
                    </tr>
                </thead>
                <tbody id="buyingCostsBody"></tbody>
            </table>

            <h3 style="margin: 30px 0 20px; color: #0f172a; font-size: 1.25rem;">Carrying Costs Breakdown</h3>
            <table class="breakdown-table">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th style="text-align: right;">Monthly</th>
                        <th style="text-align: right;">Total</th>
                    </tr>
                </thead>
                <tbody id="carryingCostsBody"></tbody>
            </table>

            <h3 style="margin: 30px 0 20px; color: #0f172a; font-size: 1.25rem;">Selling Costs Breakdown</h3>
            <table class="breakdown-table">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th style="text-align: right;">Amount</th>
                    </tr>
                </thead>
                <tbody id="sellingCostsBody"></tbody>
            </table>

            <h3 style="margin: 30px 0 20px; color: #0f172a; font-size: 1.25rem;">Investment Summary</h3>
            <div class="summary-section">
                <div class="summary-row">
                    <span class="summary-label">Purchase Price</span>
                    <span class="summary-value" id="summary-purchase">$0</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Renovation Costs</span>
                    <span class="summary-value" id="summary-renovation">$0</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Buying Costs</span>
                    <span class="summary-value" id="summary-buying">$0</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Carrying Costs</span>
                    <span class="summary-value" id="summary-carrying">$0</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Selling Costs</span>
                    <span class="summary-value" id="summary-selling">$0</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Total Project Cost</span>
                    <span class="summary-value" id="summary-total">$0</span>
                </div>
            </div>

            <div class="info-note">
                <strong>💡 Note:</strong> All figures are estimates based on the inputs provided. Please verify actual costs with lenders, contractors, and real estate professionals before making investment decisions.
            </div>

            <div class="action-buttons">
                <button class="btn-action" onclick="printReport()">🖨️ Print Report</button>
                <button class="btn-action" onclick="emailReport()">📧 Email Report</button>
                <button class="btn-primary-action" onclick="saveReport()">💾 Save Project</button>
            </div>
        </div>

        <!-- Detailed Underwriting Report -->
        <div id="underwritingReport" class="report" style="display: none;">
            <div class="report-header">
                <div class="report-title">Investment Underwriting Report</div>
                <div class="report-subtitle" id="reportProjectTitle">Property Investment Analysis</div>
                <div class="report-subtitle" id="reportDate"></div>
            </div>

            <h3 style="margin: 30px 0 20px; color: #0f172a; font-size: 1.25rem;">Executive Summary</h3>
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">Purchase Price</div>
                    <div class="metric-value" id="report-purchase">$0</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">After Repair Value</div>
                    <div class="metric-value" id="report-arv">$0</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Total Investment</div>
                    <div class="metric-value" id="report-total-investment">$0</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Net Profit</div>
                    <div class="metric-value positive" id="report-net-profit">$0</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">ROI</div>
                    <div class="metric-value" id="report-roi">0%</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Annualized ROI</div>
                    <div class="metric-value" id="report-annual-roi">0%</div>
                </div>
            </div>

            <h3 style="margin: 30px 0 20px; color: #0f172a; font-size: 1.25rem;">Financing Structure</h3>
            <div class="summary-section">
                <div class="summary-row">
                    <span class="summary-label">Loan Amount</span>
                    <span class="summary-value" id="report-loan-amount">$0</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Interest Rate</span>
                    <span class="summary-value" id="report-interest-rate">0%</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Loan Term</span>
                    <span class="summary-value" id="report-loan-term">0 months</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Monthly Interest Payment</span>
                    <span class="summary-value" id="report-monthly-payment">$0</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Total Interest Paid</span>
                    <span class="summary-value" id="report-total-interest">$0</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Out of Pocket Required</span>
                    <span class="summary-value" id="report-out-of-pocket">$0</span>
                </div>
            </div>

            <h3 style="margin: 30px 0 20px; color: #0f172a; font-size: 1.25rem;">Buying Costs Breakdown</h3>
            <table class="breakdown-table">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th style="text-align: right;">Amount</th>
                    </tr>
                </thead>
                <tbody id="report-buying-costs"></tbody>
            </table>

            <h3 style="margin: 30px 0 20px; color: #0f172a; font-size: 1.25rem;">Carrying Costs Breakdown</h3>
            <table class="breakdown-table">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th style="text-align: right;">Monthly</th>
                        <th style="text-align: right;">Total</th>
                    </tr>
                </thead>
                <tbody id="report-carrying-costs"></tbody>
            </table>

            <h3 style="margin: 30px 0 20px; color: #0f172a; font-size: 1.25rem;">Selling Costs Breakdown</h3>
            <table class="breakdown-table">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th style="text-align: right;">Amount</th>
                    </tr>
                </thead>
                <tbody id="report-selling-costs"></tbody>
            </table>

            <h3 style="margin: 30px 0 20px; color: #0f172a; font-size: 1.25rem;">Investment Summary</h3>
            <div class="summary-section">
                <div class="summary-row">
                    <span class="summary-label">Purchase Price</span>
                    <span class="summary-value" id="report-summary-purchase">$0</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Renovation Costs</span>
                    <span class="summary-value" id="report-summary-renovation">$0</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Buying Costs</span>
                    <span class="summary-value" id="report-summary-buying">$0</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Carrying Costs</span>
                    <span class="summary-value" id="report-summary-carrying">$0</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Selling Costs</span>
                    <span class="summary-value" id="report-summary-selling">$0</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Total Project Cost</span>
                    <span class="summary-value" id="report-summary-total">$0</span>
                </div>
            </div>

            <div class="info-note">
                <strong>📊 Professional Underwriting Report:</strong> This comprehensive analysis includes all project costs, financing details, and return projections. Use this report when presenting to investors, lenders, or partners.
            </div>

            <div class="action-buttons">
                <button class="btn-action" onclick="window.print()">🖨️ Print Report</button>
                <button class="btn-action" onclick="emailReport()">📧 Email Report</button>
                <button class="btn-primary-action" onclick="saveReport()">💾 Save Project</button>
            </div>
        </div>
    </div>

    <script>
        let calculationData = null;
        let costsChart = null;

        // Load saved file
        document.getElementById('loadFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const data = JSON.parse(event.target.result);
                    
                    // Populate all fields
                    document.getElementById('projectTitle').value = data.projectTitle || '';
                    document.getElementById('purchasePrice').value = data.purchasePrice || 0;
                    document.getElementById('renovationCosts').value = data.renovationCosts || 0;
                    document.getElementById('arv').value = data.arv || 0;
                    document.getElementById('interestRate').value = data.interestRate || 0;
                    document.getElementById('loanTerm').value = data.loanTerm || 0;
                    document.getElementById('maxLTV').value = data.maxLTV || 0;
                    document.getElementById('titleCompany').value = data.titleCompany || 0;
                    document.getElementById('buyTransferTax').value = data.buyTransferTax || 0;
                    document.getElementById('lenderPoints').value = data.lenderPoints || 0;
                    document.getElementById('otherBuying').value = data.otherBuying || 0;
                    document.getElementById('propertyTax').value = data.propertyTax || 0;
                    document.getElementById('insurance').value = data.insurance || 0;
                    document.getElementById('utilities').value = data.utilities || 0;
                    document.getElementById('otherCarrying').value = data.otherCarrying || 0;
                    document.getElementById('agentCommission').value = data.agentCommission || 0;
                    document.getElementById('sellTransferTax').value = data.sellTransferTax || 0;
                    document.getElementById('buyerContributions').value = data.buyerContributions || 0;
                    document.getElementById('otherSelling').value = data.otherSelling || 0;

                    alert('Project loaded successfully!');
                } catch (error) {
                    alert('Error loading file. Please make sure it\'s a valid project file.');
                }
            };
            reader.readAsText(file);
        });

        function toggleSection(header) {
            const section = header.parentElement;
            section.classList.toggle('collapsed');
        }

        function formatCurrency(value) {
            return '$' + Math.round(value).toLocaleString('en-US');
        }

        function calculate() {
            // Get all input values
            const projectTitle = document.getElementById('projectTitle').value || 'Investment Property';
            const purchasePrice = parseFloat(document.getElementById('purchasePrice').value) || 0;
            const renovationCosts = parseFloat(document.getElementById('renovationCosts').value) || 0;
            const arv = parseFloat(document.getElementById('arv').value) || 0;
            const interestRate = parseFloat(document.getElementById('interestRate').value) || 0;
            const loanTerm = parseInt(document.getElementById('loanTerm').value) || 0;
            const maxLTV = parseFloat(document.getElementById('maxLTV').value) || 0;
            const lenderPoints = parseFloat(document.getElementById('lenderPoints').value) || 0;

            // Calculate loan amount - lesser of max LTV or what's needed
            const maxLoanAmount = arv * (maxLTV / 100);
            const neededAmount = purchasePrice + renovationCosts;
            const loanAmount = Math.min(maxLoanAmount, neededAmount);

            // Buying costs
            const titleCompany = parseFloat(document.getElementById('titleCompany').value) || 0;
            const buyTransferTax = parseFloat(document.getElementById('buyTransferTax').value) || 0;
            const pointsFee = loanAmount * (lenderPoints / 100);
            const otherBuying = parseFloat(document.getElementById('otherBuying').value) || 0;
            const totalBuyingCosts = titleCompany + buyTransferTax + pointsFee + otherBuying;

            // Carrying costs
            const propertyTax = parseFloat(document.getElementById('propertyTax').value) || 0;
            const insurance = parseFloat(document.getElementById('insurance').value) || 0;
            const utilities = parseFloat(document.getElementById('utilities').value) || 0;
            const otherCarrying = parseFloat(document.getElementById('otherCarrying').value) || 0;

            const monthlyInterestRate = interestRate / 100 / 12;
            const totalInterest = loanAmount * monthlyInterestRate * loanTerm;
            const monthlyInterestPayment = loanAmount * monthlyInterestRate;

            // Monthly carrying does NOT include interest payment
            const monthlyPropertyTax = propertyTax / 12;
            const monthlyInsurance = insurance / 12;
            const monthlyCarrying = monthlyPropertyTax + monthlyInsurance + utilities + otherCarrying;
            const totalCarryingCosts = totalInterest + (monthlyCarrying * loanTerm);

            // Selling costs
            const agentCommission = parseFloat(document.getElementById('agentCommission').value) || 0;
            const commissionAmount = arv * (agentCommission / 100);
            const sellTransferTax = parseFloat(document.getElementById('sellTransferTax').value) || 0;
            const buyerContributions = parseFloat(document.getElementById('buyerContributions').value) || 0;
            const otherSelling = parseFloat(document.getElementById('otherSelling').value) || 0;
            const totalSellingCosts = commissionAmount + sellTransferTax + buyerContributions + otherSelling;

            // Final calculations
            const totalCosts = purchasePrice + renovationCosts + totalBuyingCosts + totalCarryingCosts + totalSellingCosts;
            const outOfPocket = neededAmount - loanAmount + totalBuyingCosts + (monthlyCarrying * loanTerm);
            const netProfit = arv - totalCosts - loanAmount;
            const roi = outOfPocket > 0 ? (netProfit / outOfPocket) * 100 : 0;
            const annualizedRoi = loanTerm > 0 ? (roi / loanTerm) * 12 : 0;

            // Store calculation data
            calculationData = {
                projectTitle,
                purchasePrice,
                renovationCosts,
                arv,
                interestRate,
                loanTerm,
                maxLTV,
                lenderPoints,
                titleCompany,
                buyTransferTax,
                otherBuying,
                propertyTax,
                insurance,
                utilities,
                otherCarrying,
                agentCommission,
                sellTransferTax,
                buyerContributions,
                otherSelling,
                loanAmount,
                pointsFee,
                monthlyInterestRate,
                totalInterest,
                monthlyInterestPayment,
                totalBuyingCosts,
                monthlyPropertyTax,
                monthlyInsurance,
                monthlyCarrying,
                totalCarryingCosts,
                commissionAmount,
                totalSellingCosts,
                totalCosts,
                outOfPocket,
                netProfit,
                roi,
                annualizedRoi
            };

            displayResults(calculationData);
        }

        function displayResults(data) {
            const report = document.getElementById('quickResults');

            // Update report title
            document.getElementById('reportTitle').textContent = 
                data.projectTitle ? `${data.projectTitle} - Analysis Report` : 'Investment Analysis Report';

            // Update metrics
            document.getElementById('netProfit').textContent = formatCurrency(data.netProfit);
            document.getElementById('netProfit').className = 'metric-value ' + (data.netProfit >= 0 ? 'positive' : 'negative');
            document.getElementById('roi').textContent = data.roi.toFixed(2) + '%';
            document.getElementById('annualizedRoi').textContent = data.annualizedRoi.toFixed(2) + '%';
            document.getElementById('totalInvestment').textContent = formatCurrency(data.outOfPocket);

            // Update financing structure
            document.getElementById('loanAmount').textContent = formatCurrency(data.loanAmount);
            document.getElementById('outOfPocket').textContent = formatCurrency(data.outOfPocket);
            document.getElementById('monthlyInterest').textContent = formatCurrency(data.monthlyInterestPayment);
            document.getElementById('totalInterest').textContent = formatCurrency(data.totalInterest);

            // Update buying costs table
            document.getElementById('buyingCostsBody').innerHTML =
                '<tr><td>Title Company Fee</td><td style="text-align: right;">' + formatCurrency(data.titleCompany) + '</td></tr>' +
                '<tr><td>Transfer Tax</td><td style="text-align: right;">' + formatCurrency(data.buyTransferTax) + '</td></tr>' +
                '<tr><td>Lender Points (' + data.lenderPoints + '%)</td><td style="text-align: right;">' + formatCurrency(data.pointsFee) + '</td></tr>' +
                '<tr><td>Other Costs</td><td style="text-align: right;">' + formatCurrency(data.otherBuying) + '</td></tr>' +
                '<tr class="total-row"><td>Total Buying Costs</td><td style="text-align: right;">' + formatCurrency(data.totalBuyingCosts) + '</td></tr>';

            // Update carrying costs table
            const totalPropertyTax = data.monthlyPropertyTax * data.loanTerm;
            const totalInsurance = data.monthlyInsurance * data.loanTerm;
            const totalUtilities = data.utilities * data.loanTerm;
            const totalOtherCarrying = data.otherCarrying * data.loanTerm;

            document.getElementById('carryingCostsBody').innerHTML =
                '<tr><td>Interest Payments</td><td style="text-align: right;">' + formatCurrency(data.monthlyInterestPayment) + '</td><td style="text-align: right;">' + formatCurrency(data.totalInterest) + '</td></tr>' +
                '<tr><td>Property Tax</td><td style="text-align: right;">' + formatCurrency(data.monthlyPropertyTax) + '</td><td style="text-align: right;">' + formatCurrency(totalPropertyTax) + '</td></tr>' +
                '<tr><td>Insurance</td><td style="text-align: right;">' + formatCurrency(data.monthlyInsurance) + '</td><td style="text-align: right;">' + formatCurrency(totalInsurance) + '</td></tr>' +
                '<tr><td>Utilities</td><td style="text-align: right;">' + formatCurrency(data.utilities) + '</td><td style="text-align: right;">' + formatCurrency(totalUtilities) + '</td></tr>' +
                '<tr><td>Other Monthly Costs</td><td style="text-align: right;">' + formatCurrency(data.otherCarrying) + '</td><td style="text-align: right;">' + formatCurrency(totalOtherCarrying) + '</td></tr>' +
                '<tr class="total-row"><td>Total Carrying Costs</td><td style="text-align: right;">' + formatCurrency(data.monthlyCarrying) + '</td><td style="text-align: right;">' + formatCurrency(data.totalCarryingCosts) + '</td></tr>';

            // Update selling costs table
            document.getElementById('sellingCostsBody').innerHTML =
                '<tr><td>Agent Commission (' + data.agentCommission + '%)</td><td style="text-align: right;">' + formatCurrency(data.commissionAmount) + '</td></tr>' +
                '<tr><td>Transfer Tax</td><td style="text-align: right;">' + formatCurrency(data.sellTransferTax) + '</td></tr>' +
                '<tr><td>Buyer Contributions</td><td style="text-align: right;">' + formatCurrency(data.buyerContributions) + '</td></tr>' +
                '<tr><td>Other Costs</td><td style="text-align: right;">' + formatCurrency(data.otherSelling) + '</td></tr>' +
                '<tr class="total-row"><td>Total Selling Costs</td><td style="text-align: right;">' + formatCurrency(data.totalSellingCosts) + '</td></tr>';

            // Update summary
            document.getElementById('summary-purchase').textContent = formatCurrency(data.purchasePrice);
            document.getElementById('summary-renovation').textContent = formatCurrency(data.renovationCosts);
            document.getElementById('summary-buying').textContent = formatCurrency(data.totalBuyingCosts);
            document.getElementById('summary-carrying').textContent = formatCurrency(data.totalCarryingCosts);
            document.getElementById('summary-selling').textContent = formatCurrency(data.totalSellingCosts);
            document.getElementById('summary-total').textContent = formatCurrency(data.totalCosts);

            // Update chart
            updateChart(data);

            // Show/hide deal alert
            const dealAlert = document.getElementById('dealAlert');
            if (data.netProfit > 0 && data.roi > 15) {
                dealAlert.classList.add('show');
            } else {
                dealAlert.classList.remove('show');
            }

            // Show report and scroll to it
            report.classList.add('show');
            
            // Hide underwriting report when recalculating
            document.getElementById('underwritingReport').style.display = 'none';
            
            report.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function updateChart(data) {
            const ctx = document.getElementById('costsChart').getContext('2d');

            if (costsChart) {
                costsChart.destroy();
            }

            costsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Purchase', 'Renovation', 'Buying Costs', 'Carrying Costs', 'Selling Costs', 'ARV', 'Net Profit'],
                    datasets: [{
                        label: 'Amount ($)',
                        data: [
                            data.purchasePrice,
                            data.renovationCosts,
                            data.totalBuyingCosts,
                            data.totalCarryingCosts,
                            data.totalSellingCosts,
                            data.arv,
                            data.netProfit
                        ],
                        backgroundColor: [
                            '#3b82f6',
                            '#8b5cf6',
                            '#ec4899',
                            '#f59e0b',
                            '#ef4444',
                            '#22c55e',
                            data.netProfit >= 0 ? '#22c55e' : '#ef4444'
                        ],
                        borderColor: [
                            '#2563eb',
                            '#7c3aed',
                            '#db2777',
                            '#d97706',
                            '#dc2626',
                            '#16a34a',
                            data.netProfit >= 0 ? '#16a34a' : '#dc2626'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Investment Cost Breakdown',
                            font: {
                                size: 16,
                                weight: '600'
                            },
                            color: '#0f172a'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'K';
                                },
                                color: '#64748b'
                            },
                            grid: {
                                color: '#e2e8f0'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#64748b'
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        function printReport() {
            window.print();
        }

        function emailReport() {
            const data = calculationData;
            const monthlyInterestPayment = data.loanAmount * data.monthlyInterestRate;
            const monthlyPropertyTax = data.propertyTax / 12;
            const monthlyInsurance = data.insurance / 12;
            const totalPropertyTax = monthlyPropertyTax * data.loanTerm;
            const totalInsurance = monthlyInsurance * data.loanTerm;
            const totalUtilities = data.utilities * data.loanTerm;
            const totalOtherCarrying = data.otherCarrying * data.loanTerm;
            
            const subject = encodeURIComponent('Investment Analysis Report: ' + (data.projectTitle || 'Property Investment'));
            
            const body = encodeURIComponent(
                '═══════════════════════════════════════════════════════\n' +
                'INVESTMENT ANALYSIS REPORT\n' +
                '═══════════════════════════════════════════════════════\n\n' +
                'Property: ' + (data.projectTitle || 'Investment Property') + '\n' +
                'Generated: ' + new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) + '\n\n' +
                
                '───────────────────────────────────────────────────────\n' +
                'EXECUTIVE SUMMARY\n' +
                '───────────────────────────────────────────────────────\n' +
                'Purchase Price:           ' + formatCurrency(data.purchasePrice) + '\n' +
                'Renovation Costs:         ' + formatCurrency(data.renovationCosts) + '\n' +
                'After Repair Value (ARV): ' + formatCurrency(data.arv) + '\n' +
                'Total Investment:         ' + formatCurrency(data.totalCosts + data.loanAmount) + '\n' +
                'Net Profit:               ' + formatCurrency(data.netProfit) + '\n' +
                'ROI:                      ' + data.roi.toFixed(2) + '%\n' +
                'Annualized ROI:           ' + data.annualizedRoi.toFixed(2) + '%\n\n' +
                
                '───────────────────────────────────────────────────────\n' +
                'FINANCING STRUCTURE\n' +
                '───────────────────────────────────────────────────────\n' +
                'Loan Amount:                ' + formatCurrency(data.loanAmount) + '\n' +
                'Interest Rate:              ' + data.interestRate + '% annually\n' +
                'Loan Term:                  ' + data.loanTerm + ' months\n' +
                'Monthly Interest Payment:   ' + formatCurrency(monthlyInterestPayment) + '\n' +
                'Total Interest Paid:        ' + formatCurrency(data.totalInterest) + '\n' +
                'Out of Pocket Required:     ' + formatCurrency(data.outOfPocket) + '\n' +
                'Loan-to-Value (ARV):        ' + data.maxLTV + '%\n\n' +
                
                '───────────────────────────────────────────────────────\n' +
                'BUYING COSTS BREAKDOWN\n' +
                '───────────────────────────────────────────────────────\n' +
                'Title Company Fee:        ' + formatCurrency(data.titleCompany) + '\n' +
                'Transfer Tax:             ' + formatCurrency(data.buyTransferTax) + '\n' +
                'Lender Points (' + data.lenderPoints + '%):     ' + formatCurrency(data.pointsFee) + '\n' +
                'Other Buying Costs:       ' + formatCurrency(data.otherBuying) + '\n' +
                '                          ──────────────\n' +
                'Total Buying Costs:       ' + formatCurrency(data.totalBuyingCosts) + '\n\n' +
                
                '───────────────────────────────────────────────────────\n' +
                'CARRYING COSTS BREAKDOWN (' + data.loanTerm + ' months)\n' +
                '───────────────────────────────────────────────────────\n' +
                '                          Monthly         Total\n' +
                'Interest Payments:        ' + formatCurrency(monthlyInterestPayment).padEnd(15) + ' ' + formatCurrency(data.totalInterest) + '\n' +
                'Property Tax:             ' + formatCurrency(monthlyPropertyTax).padEnd(15) + ' ' + formatCurrency(totalPropertyTax) + '\n' +
                'Insurance:                ' + formatCurrency(monthlyInsurance).padEnd(15) + ' ' + formatCurrency(totalInsurance) + '\n' +
                'Utilities:                ' + formatCurrency(data.utilities).padEnd(15) + ' ' + formatCurrency(totalUtilities) + '\n' +
                'Other Monthly Costs:      ' + formatCurrency(data.otherCarrying).padEnd(15) + ' ' + formatCurrency(totalOtherCarrying) + '\n' +
                '                          ──────────────  ──────────────\n' +
                'Total Carrying Costs:     ' + formatCurrency(data.monthlyCarrying).padEnd(15) + ' ' + formatCurrency(data.totalCarryingCosts) + '\n\n' +
                
                '───────────────────────────────────────────────────────\n' +
                'SELLING COSTS BREAKDOWN\n' +
                '───────────────────────────────────────────────────────\n' +
                'Agent Commission (' + data.agentCommission + '%): ' + formatCurrency(data.commissionAmount) + '\n' +
                'Transfer Tax:             ' + formatCurrency(data.sellTransferTax) + '\n' +
                'Buyer Contributions:      ' + formatCurrency(data.buyerContributions) + '\n' +
                'Other Selling Costs:      ' + formatCurrency(data.otherSelling) + '\n' +
                '                          ──────────────\n' +
                'Total Selling Costs:      ' + formatCurrency(data.totalSellingCosts) + '\n\n' +
                
                '───────────────────────────────────────────────────────\n' +
                'INVESTMENT SUMMARY\n' +
                '───────────────────────────────────────────────────────\n' +
                'Purchase Price:           ' + formatCurrency(data.purchasePrice) + '\n' +
                'Renovation Costs:         ' + formatCurrency(data.renovationCosts) + '\n' +
                'Buying Costs:             ' + formatCurrency(data.totalBuyingCosts) + '\n' +
                'Carrying Costs:           ' + formatCurrency(data.totalCarryingCosts) + '\n' +
                'Selling Costs:            ' + formatCurrency(data.totalSellingCosts) + '\n' +
                '                          ──────────────\n' +
                'TOTAL PROJECT COST:       ' + formatCurrency(data.totalCosts) + '\n\n' +
                'After Repair Value:       ' + formatCurrency(data.arv) + '\n' +
                'Less: Loan Payoff:        -' + formatCurrency(data.loanAmount) + '\n' +
                'Less: Total Costs:        -' + formatCurrency(data.totalCosts) + '\n' +
                '                          ──────────────\n' +
                'NET PROFIT:               ' + formatCurrency(data.netProfit) + '\n\n' +
                
                '═══════════════════════════════════════════════════════\n' +
                'KEY METRICS\n' +
                '═══════════════════════════════════════════════════════\n' +
                'Return on Investment:     ' + data.roi.toFixed(2) + '%\n' +
                'Annualized ROI:           ' + data.annualizedRoi.toFixed(2) + '%\n' +
                'Cash Required:            ' + formatCurrency(data.outOfPocket) + '\n' +
                'Total Profit:             ' + formatCurrency(data.netProfit) + '\n' +
                'Project Duration:         ' + data.loanTerm + ' months\n\n' +
                
                '───────────────────────────────────────────────────────\n' +
                'This detailed analysis was generated using the Hard Money\n' +
                'Loan Calculator. All figures are estimates and should be\n' +
                'verified with actual quotes and market data.\n' +
                '───────────────────────────────────────────────────────'
            );

            window.location.href = 'mailto:?subject=' + subject + '&body=' + body;
        }

        function saveReport() {
            const data = {
                projectTitle: document.getElementById('projectTitle').value,
                purchasePrice: parseFloat(document.getElementById('purchasePrice').value) || 0,
                renovationCosts: parseFloat(document.getElementById('renovationCosts').value) || 0,
                arv: parseFloat(document.getElementById('arv').value) || 0,
                interestRate: parseFloat(document.getElementById('interestRate').value) || 0,
                loanTerm: parseInt(document.getElementById('loanTerm').value) || 0,
                maxLTV: parseFloat(document.getElementById('maxLTV').value) || 0,
                titleCompany: parseFloat(document.getElementById('titleCompany').value) || 0,
                buyTransferTax: parseFloat(document.getElementById('buyTransferTax').value) || 0,
                lenderPoints: parseFloat(document.getElementById('lenderPoints').value) || 0,
                otherBuying: parseFloat(document.getElementById('otherBuying').value) || 0,
                propertyTax: parseFloat(document.getElementById('propertyTax').value) || 0,
                insurance: parseFloat(document.getElementById('insurance').value) || 0,
                utilities: parseFloat(document.getElementById('utilities').value) || 0,
                otherCarrying: parseFloat(document.getElementById('otherCarrying').value) || 0,
                agentCommission: parseFloat(document.getElementById('agentCommission').value) || 0,
                sellTransferTax: parseFloat(document.getElementById('sellTransferTax').value) || 0,
                buyerContributions: parseFloat(document.getElementById('buyerContributions').value) || 0,
                otherSelling: parseFloat(document.getElementById('otherSelling').value) || 0,
                savedDate: new Date().toISOString()
            };

            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const filename = (data.projectTitle ? data.projectTitle.replace(/[^a-z0-9]/gi, '_') : 'Property') + '_' + new Date().toISOString().split('T')[0] + '.json';
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function generateReport() {
            const data = calculationData;
            if (!data) {
                alert('Please calculate the investment first.');
                return;
            }

            const report = document.getElementById('underwritingReport');

            // Update header
            document.getElementById('reportProjectTitle').textContent = data.projectTitle || 'Investment Property Analysis';
            document.getElementById('reportDate').textContent = 'Generated: ' + new Date().toLocaleDateString('en-US', { 
                year: 'numeric', month: 'long', day: 'numeric' 
            });

            // Update executive summary
            document.getElementById('report-purchase').textContent = formatCurrency(data.purchasePrice);
            document.getElementById('report-arv').textContent = formatCurrency(data.arv);
            document.getElementById('report-total-investment').textContent = formatCurrency(data.totalCosts + data.loanAmount);
            document.getElementById('report-net-profit').textContent = formatCurrency(data.netProfit);
            document.getElementById('report-net-profit').className = 'metric-value ' + (data.netProfit >= 0 ? 'positive' : 'negative');
            document.getElementById('report-roi').textContent = data.roi.toFixed(2) + '%';
            document.getElementById('report-annual-roi').textContent = data.annualizedRoi.toFixed(2) + '%';

            // Update financing structure
            document.getElementById('report-loan-amount').textContent = formatCurrency(data.loanAmount);
            document.getElementById('report-interest-rate').textContent = data.interestRate + '% annually';
            document.getElementById('report-loan-term').textContent = data.loanTerm + ' months';
            document.getElementById('report-monthly-payment').textContent = formatCurrency(data.monthlyInterestPayment);
            document.getElementById('report-total-interest').textContent = formatCurrency(data.totalInterest);
            document.getElementById('report-out-of-pocket').textContent = formatCurrency(data.outOfPocket);

            // Update buying costs breakdown
            document.getElementById('report-buying-costs').innerHTML =
                '<tr><td>Title Company Fee</td><td style="text-align: right;">' + formatCurrency(data.titleCompany) + '</td></tr>' +
                '<tr><td>Transfer Tax</td><td style="text-align: right;">' + formatCurrency(data.buyTransferTax) + '</td></tr>' +
                '<tr><td>Lender Points (' + data.lenderPoints + '%)</td><td style="text-align: right;">' + formatCurrency(data.pointsFee) + '</td></tr>' +
                '<tr><td>Other Costs</td><td style="text-align: right;">' + formatCurrency(data.otherBuying) + '</td></tr>' +
                '<tr class="total-row"><td>Total Buying Costs</td><td style="text-align: right;">' + formatCurrency(data.totalBuyingCosts) + '</td></tr>';

            // Update carrying costs breakdown
            const totalPropertyTax = data.monthlyPropertyTax * data.loanTerm;
            const totalInsurance = data.monthlyInsurance * data.loanTerm;
            const totalUtilities = data.utilities * data.loanTerm;
            const totalOtherCarrying = data.otherCarrying * data.loanTerm;

            document.getElementById('report-carrying-costs').innerHTML =
                '<tr><td>Interest Payments</td><td style="text-align: right;">' + formatCurrency(data.monthlyInterestPayment) + '</td><td style="text-align: right;">' + formatCurrency(data.totalInterest) + '</td></tr>' +
                '<tr><td>Property Tax</td><td style="text-align: right;">' + formatCurrency(data.monthlyPropertyTax) + '</td><td style="text-align: right;">' + formatCurrency(totalPropertyTax) + '</td></tr>' +
                '<tr><td>Insurance</td><td style="text-align: right;">' + formatCurrency(data.monthlyInsurance) + '</td><td style="text-align: right;">' + formatCurrency(totalInsurance) + '</td></tr>' +
                '<tr><td>Utilities</td><td style="text-align: right;">' + formatCurrency(data.utilities) + '</td><td style="text-align: right;">' + formatCurrency(totalUtilities) + '</td></tr>' +
                '<tr><td>Other Monthly Costs</td><td style="text-align: right;">' + formatCurrency(data.otherCarrying) + '</td><td style="text-align: right;">' + formatCurrency(totalOtherCarrying) + '</td></tr>' +
                '<tr class="total-row"><td>Total Carrying Costs</td><td style="text-align: right;">' + formatCurrency(data.monthlyCarrying) + '</td><td style="text-align: right;">' + formatCurrency(data.totalCarryingCosts) + '</td></tr>';

            // Update selling costs breakdown
            document.getElementById('report-selling-costs').innerHTML =
                '<tr><td>Agent Commission (' + data.agentCommission + '%)</td><td style="text-align: right;">' + formatCurrency(data.commissionAmount) + '</td></tr>' +
                '<tr><td>Transfer Tax</td><td style="text-align: right;">' + formatCurrency(data.sellTransferTax) + '</td></tr>' +
                '<tr><td>Buyer Contributions</td><td style="text-align: right;">' + formatCurrency(data.buyerContributions) + '</td></tr>' +
                '<tr><td>Other Costs</td><td style="text-align: right;">' + formatCurrency(data.otherSelling) + '</td></tr>' +
                '<tr class="total-row"><td>Total Selling Costs</td><td style="text-align: right;">' + formatCurrency(data.totalSellingCosts) + '</td></tr>';

            // Update investment summary
            document.getElementById('report-summary-purchase').textContent = formatCurrency(data.purchasePrice);
            document.getElementById('report-summary-renovation').textContent = formatCurrency(data.renovationCosts);
            document.getElementById('report-summary-buying').textContent = formatCurrency(data.totalBuyingCosts);
            document.getElementById('report-summary-carrying').textContent = formatCurrency(data.totalCarryingCosts);
            document.getElementById('report-summary-selling').textContent = formatCurrency(data.totalSellingCosts);
            document.getElementById('report-summary-total').textContent = formatCurrency(data.totalCosts);

            // Show the report and scroll to it
            report.style.display = 'block';
            report.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    </script>
</body>
</html>
